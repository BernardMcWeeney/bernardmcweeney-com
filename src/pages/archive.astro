---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";

// Fetch all content
const blog = (await getCollection("blog")).filter(p => !p.data.draft);

// Try to get notes if the collection exists
let notes: any[] = [];
try {
  notes = (await getCollection("notes")).filter((p: any) => !p.data?.draft);
} catch {
  // Collection doesn't exist yet
}

// Combine and sort all content
const allContent = [
  ...blog.map(p => ({
    ...p,
    type: 'post',
    date: p.data.pubDate,
    href: `/blog/${p.slug}/`,
  })),
  ...notes.map(n => ({
    ...n,
    type: 'note',
    date: n.data.date,
    href: `/notes/${n.slug}/`,
  })),
].sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());

// Group by year
const contentByYear = allContent.reduce((acc, item) => {
  const year = new Date(item.date).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(item);
  return acc;
}, {} as Record<number, typeof allContent>);

const years = Object.keys(contentByYear).map(Number).sort((a, b) => b - a);
---

<Layout 
  title="Archive" 
  description="Complete archive of all posts and notes on bernardmcweeney.com"
>
  <div class="container py-8 md:py-12">
    
    <!-- Page Header -->
    <header class="mb-10">
      <h1 class="text-3xl md:text-4xl font-semibold text-[var(--color-text-primary)]">
        Archive
      </h1>
      <p class="text-[var(--color-text-secondary)] mt-2">
        Everything I've published, organized by year.
      </p>
      <div class="flex gap-4 mt-4 text-sm text-[var(--color-text-muted)]">
        <span><strong class="text-[var(--color-text-primary)]">{allContent.length}</strong> total items</span>
        <span><strong class="text-[var(--color-text-primary)]">{blog.length}</strong> posts</span>
        {notes.length > 0 && (
          <span><strong class="text-[var(--color-text-primary)]">{notes.length}</strong> notes</span>
        )}
      </div>
    </header>

    <!-- Archive by Year -->
    {allContent.length === 0 ? (
      <div class="card p-8 text-center">
        <p class="text-[var(--color-text-muted)]">No content yet. Check back soon!</p>
      </div>
    ) : (
      <div class="space-y-10">
        {years.map(year => (
          <section class="card overflow-hidden">
            <div class="px-4 py-3 bg-[var(--color-bg-elevated)] border-b border-[var(--color-border)] flex items-center justify-between">
              <span class="font-mono text-lg font-semibold text-[var(--color-text-primary)]">
                {year}
              </span>
              <span class="text-xs text-[var(--color-text-dimmed)]">
                {contentByYear[year].length} item{contentByYear[year].length !== 1 ? 's' : ''}
              </span>
            </div>
            
            <ul class="divide-y divide-[var(--color-border)]">
              {contentByYear[year].map(item => {
                const date = new Date(item.date).toLocaleDateString('en-IE', {
                  month: 'short',
                  day: 'numeric',
                });
                return (
                  <li>
                    <a 
                      href={item.href} 
                      class="flex items-center gap-4 px-4 py-3 hover:bg-[var(--color-bg-elevated)] transition-colors"
                    >
                      <span class="font-mono text-xs text-[var(--color-text-dimmed)] w-16 flex-shrink-0">
                        {date}
                      </span>
                      <span class="badge flex-shrink-0">
                        {item.type}
                      </span>
                      <span class="font-mono text-sm text-[var(--color-text-primary)] truncate">
                        {item.data.title}
                      </span>
                    </a>
                  </li>
                );
              })}
            </ul>
          </section>
        ))}
      </div>
    )}

  </div>
</Layout>