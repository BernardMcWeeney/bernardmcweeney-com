---
import RackLayout from "../layouts/RackLayout.astro";
import { getCollection } from "astro:content";

const posts = (await getCollection("blog"))
  .filter(p => !p.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Group by year and month
const postsByYearMonth = posts.reduce((acc, post) => {
  const date = new Date(post.data.pubDate);
  const year = date.getFullYear();
  const month = date.toLocaleString('en', { month: 'short' }).toUpperCase();
  const key = `${year}-${month}`;
  
  if (!acc[key]) {
    acc[key] = { year, month, posts: [] };
  }
  acc[key].posts.push(post);
  return acc;
}, {} as Record<string, { year: number; month: string; posts: typeof posts }>);

const sortedKeys = Object.keys(postsByYearMonth).sort().reverse();
---

<RackLayout 
  title="Archive" 
  description="Complete archive of all content from Bernard McWeeney"
>
  <!-- Header -->
  <div class="blade" data-unit="1U">
    <div class="blade-face">
      <div class="led-cluster">
        <span class="led on"></span>
        <span class="led on"></span>
      </div>
      <span class="blade-label">
        ARCHIVE
        <span class="model">find /var/log -type f -name "*.log"</span>
      </span>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="blade" data-unit="1U">
    <div class="blade-content" style="padding: 0.75rem;">
      <div class="archive-stats">
        <div class="stat-item">
          <span class="stat-num">{posts.length}</span>
          <span class="stat-label">Total Posts</span>
        </div>
        <div class="stat-item">
          <span class="stat-num">{Object.keys(postsByYearMonth).length}</span>
          <span class="stat-label">Months Active</span>
        </div>
        <div class="stat-item">
          <span class="stat-num">{new Set(posts.flatMap(p => p.data.tags || [])).size}</span>
          <span class="stat-label">Unique Tags</span>
        </div>
      </div>
    </div>
  </div>

  {posts.length === 0 ? (
    <div class="blade" data-unit="2U">
      <div class="blade-content">
        <div class="terminal">
          <div class="terminal-body">
            <div class="terminal-line">
              <span class="output muted">No archived content found.</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  ) : (
    <!-- Archive Timeline -->
    <div class="blade" data-unit="4U">
      <div class="blade-content">
        <div class="timeline">
          {sortedKeys.map(key => {
            const group = postsByYearMonth[key];
            return (
              <div class="timeline-group">
                <div class="timeline-header">
                  <span class="led on"></span>
                  <span class="timeline-date">{group.month} {group.year}</span>
                  <span class="timeline-count">{group.posts.length} entries</span>
                </div>
                <div class="timeline-posts">
                  {group.posts.map(post => {
                    const date = new Date(post.data.pubDate);
                    return (
                      <a href={`/blog/${post.slug}/`} class="timeline-post">
                        <span class="post-day">{String(date.getDate()).padStart(2, '0')}</span>
                        <span class="post-title">{post.data.title}</span>
                        {post.data.tags?.[0] && (
                          <span class="badge">{post.data.tags[0]}</span>
                        )}
                      </a>
                    );
                  })}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  )}
</RackLayout>

<style>
  .archive-stats {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .stat-item {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }

  .stat-num {
    font-size: 20px;
    font-weight: 700;
    color: var(--color-term-green);
    text-shadow: var(--glow-green);
    font-variant-numeric: tabular-nums;
  }

  .stat-label {
    font-size: 11px;
    color: var(--color-term-dark);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Timeline */
  .timeline {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .timeline-group {
    background: var(--color-panel);
    border: 1px solid var(--color-border);
  }

  .timeline-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--color-surface);
    border-bottom: 1px solid var(--color-border);
  }

  .timeline-header .led {
    width: 5px;
    height: 5px;
  }

  .timeline-date {
    font-size: 11px;
    font-weight: 600;
    color: var(--color-term-cyan);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .timeline-count {
    margin-left: auto;
    font-size: 10px;
    color: var(--color-term-dark);
  }

  .timeline-posts {
    display: flex;
    flex-direction: column;
  }

  .timeline-post {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--color-border);
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .timeline-post:last-child {
    border-bottom: none;
  }

  .timeline-post:hover {
    background: var(--color-chassis);
  }

  .post-day {
    font-size: 11px;
    color: var(--color-term-amber);
    font-variant-numeric: tabular-nums;
    min-width: 24px;
  }

  .post-title {
    flex: 1;
    font-size: 12px;
    color: var(--color-term-white);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .timeline-post:hover .post-title {
    color: var(--color-term-green);
  }
</style>