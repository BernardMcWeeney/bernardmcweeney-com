---
import Layout from "../../layouts/Layout.astro";
import SectionHeader from "../../components/SectionHeader.astro";
import ContentCard from "../../components/ContentCard.astro";
import { getCollection } from "astro:content";

const posts = (await getCollection("blog"))
  .filter(p => !p.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Group posts by year
const postsByYear = posts.reduce((acc, post) => {
  const year = new Date(post.data.pubDate).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);
---

<Layout 
  title="Blog" 
  description="Thoughts on technology, development, and the things I'm building."
>
  <div class="container py-8 md:py-12">
    
    <!-- Page Header -->
    <header class="mb-10">
      <h1 class="text-3xl md:text-4xl font-semibold text-[var(--color-text-primary)]">
        Blog
      </h1>
      <p class="text-[var(--color-text-secondary)] mt-2 max-w-2xl">
        Writing about technology, development, IT administration, and the projects I'm working on.
      </p>
      
      <!-- RSS Link -->
      <div class="mt-4">
        <a href="/rss.xml" class="btn btn-ghost text-xs">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5 3a1 1 0 000 2c5.523 0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z"/>
            <path d="M4 9a1 1 0 011-1 7 7 0 017 7 1 1 0 11-2 0 5 5 0 00-5-5 1 1 0 01-1-1z"/>
            <circle cx="5" cy="15" r="2"/>
          </svg>
          Subscribe via RSS
        </a>
      </div>
    </header>

    <!-- Posts by Year -->
    {posts.length === 0 ? (
      <div class="card p-8 text-center">
        <p class="text-[var(--color-text-muted)]">No posts yet. Check back soon!</p>
      </div>
    ) : (
      <div class="space-y-12">
        {years.map(year => (
          <section>
            <div class="flex items-center gap-4 mb-4">
              <span class="font-mono text-sm font-semibold text-[var(--color-brand)]">
                {year}
              </span>
              <div class="flex-1 h-px bg-[var(--color-border)]"></div>
              <span class="text-xs text-[var(--color-text-dimmed)]">
                {postsByYear[year].length} post{postsByYear[year].length !== 1 ? 's' : ''}
              </span>
            </div>
            
            <div class="space-y-3 stagger">
              {postsByYear[year].map(post => (
                <ContentCard
                  href={`/blog/${post.slug}/`}
                  title={post.data.title}
                  description={post.data.description}
                  date={post.data.pubDate}
                  tags={post.data.tags}
                />
              ))}
            </div>
          </section>
        ))}
      </div>
    )}

  </div>
</Layout>