---
import Page from "../../layouts/Page.astro";
import { getCollection } from "astro:content";
import FormattedDate from "../../components/FormattedDate.astro";

const posts = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate));

/* Buckets for sidebar */
const years = posts.reduce((acc: Record<string, number>, p) => {
  const y = String(new Date(p.data.pubDate).getFullYear());
  acc[y] = (acc[y] || 0) + 1; return acc;
}, {});
const categories = posts.reduce((acc: Record<string, number>, p) => {
  const c = (p.data.category || p.data.cat || "General") as string;
  acc[c] = (acc[c] || 0) + 1; return acc;
}, {});
const tagCounts = posts.reduce((acc: Record<string, number>, p) => {
  const tags: string[] = Array.isArray(p.data.tags) ? p.data.tags : [];
  tags.forEach((t) => { const k = t.toLowerCase(); acc[k] = (acc[k] || 0) + 1; });
  return acc;
}, {});
const counts = Object.values(tagCounts);
const max = counts.length ? Math.max(...counts) : 1;
const min = counts.length ? Math.min(...counts) : 0;
function sizeFor(n:number){ if(max===min) return 1; const r=(n-min)/(max-min); return 0.9 + r*1.2; }
---

<Page title="Blog" description="Posts on engineering, design, infra, and the odd deep dive." prompt="> ls blog/">
  <div class="container" style="max-width:72rem;margin-inline:auto;">
    <!-- perfectly centered two-column layout -->
    <div class="grid" style="grid-template-columns:minmax(0,1fr) 280px; gap:16px;">
      <!-- MAIN -->
      <section class="grid" style="grid-template-columns:1fr; gap:12px;">
        <!-- Search -->
        <div class="panel corners" style="margin-bottom:.25rem;">
          <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>
          <div class="head"><div class="icon">/</div><div class="font-mono text-sm">Search</div></div>
          <div class="body" style="padding: .6rem 1rem;">
            <div class="addr" style="display:flex;gap:.5rem;align-items:center;">
              <span class="font-mono text-sm" style="color:var(--muted)">â€º</span>
              <input id="blog-q" placeholder="Filter postsâ€¦" style="border:0;outline:0;background:transparent;width:100%;" />
              <kbd class="font-mono text-xs" style="opacity:.6">âŒ˜/</kbd>
            </div>
          </div>
        </div>

        <!-- Compact list with thumbnails -->
        <div id="blog-list" class="grid" style="grid-template-columns:1fr; gap:12px;">
          {posts.map((p) => (
            <article class="card corners" style="padding:.6rem;">
              <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>
              <a href={`/blog/${p.id}/`} class="no-underline hover:underline" style="display:grid;grid-template-columns:120px 1fr;gap:.8rem;align-items:stretch;">
                <!-- Thumb -->
                <div class="panel" style="overflow:hidden;display:grid;place-items:center;">
                  {p.data.heroImage || p.data.image ? (
                    <img src={p.data.heroImage || p.data.image} alt={p.data.title} loading="lazy" style="width:100%;height:100%;object-fit:cover;aspect-ratio:4/3;" />
                  ) : (
                    <div class="font-mono" style="font-size:1.8rem;opacity:.9">ðŸ“„</div>
                  )}
                </div>
                <!-- Copy -->
                <div>
                  <h2 class="font-mono" style="font-size:1.12rem;margin:0 0 .15rem 0;color:var(--brand);">{p.data.title}</h2>
                  <div class="font-mono text-sm" style="color:var(--muted);">
                    <FormattedDate date={p.data.pubDate} />
                    {p.data.updatedDate && <> Â· updated <FormattedDate date={p.data.updatedDate} /></>}
                    {p.data.category && <> Â· {p.data.category}</>}
                  </div>
                  {p.data.description && <p style="margin:.35rem 0 0 0;">{p.data.description}</p>}
                  {Array.isArray(p.data.tags) && p.data.tags.length>0 && (
                    <div style="margin-top:.45rem;display:flex;gap:.35rem;flex-wrap:wrap;">
                      {p.data.tags.slice(0,4).map((t)=> <span class="badge">{t}</span>)}
                    </div>
                  )}
                </div>
              </a>
            </article>
          ))}
        </div>
      </section>

      <!-- SIDEBAR -->
      <aside class="grid gap-4">
        <!-- Tag Cloud -->
        <section class="widget corners">
          <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>
          <div class="head"><div class="icon">#</div><div class="font-mono text-sm">Tags</div></div>
          <div class="body">
            {Object.entries(tagCounts).length === 0 && <div class="text-[color:var(--muted)] font-mono text-sm">No tags yet.</div>}
            <div class="flex flex-wrap gap-x-2 gap-y-1">
              {Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]).map(([tag,count]) => {
                const scale = sizeFor(count);
                return (
                  <a href={`/blog/tags/${encodeURIComponent(tag)}/`} class="no-underline hover:underline font-mono" style={`font-size:${scale}rem`} aria-label={`${tag} (${count})`}>{tag}</a>
                );
              })}
            </div>
          </div>
        </section>

        <!-- Categories -->
        <section class="widget corners">
          <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>
          <div class="head"><div class="icon">CT</div><div class="font-mono text-sm">Categories</div></div>
          <div class="body">
            <ul class="m-0 p-0 list-none">
              {Object.entries(categories).sort((a,b)=>b[1]-a[1]).map(([c, n])=>(
                <li class="py-1 border-b" style="border-color:var(--border)">
                  <a class="no-underline hover:underline font-mono" href={`/blog/categories/${encodeURIComponent(c.toLowerCase())}/`}>
                    {c} <span class="text-[color:var(--muted)]">({n})</span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </section>

        <!-- Years -->
        <section class="widget corners">
          <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>
          <div class="head"><div class="icon">YR</div><div class="font-mono text-sm">Years</div></div>
          <div class="body">
            <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:.4rem;">
              {Object.entries(years).sort((a,b)=>Number(b[0])-Number(a[0])).map(([yr, n])=>(
                <a class="badge text-center" href={`/archive/#y-${yr}`}>{yr}<span class="text-[color:var(--muted)]">Â·{n}</span></a>
              ))}
            </div>
          </div>
        </section>

        <!-- RSS -->
        <section class="panel corners">
          <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>
          <div class="head"><div class="icon">RSS</div><div class="font-mono text-sm">Subscribe</div></div>
          <div class="body font-mono text-sm"><a class="badge" href="/rss.xml">RSS Feed â†’</a></div>
        </section>
      </aside>
    </div>
  </div>

  <script>
    // Filter posts by text
    const q = document.getElementById('blog-q');
    const list = document.getElementById('blog-list');
    const onFilter = () => {
      const term = (q?.value || '').toLowerCase();
      for (const art of list.querySelectorAll('article')) {
        art.style.display = art.textContent.toLowerCase().includes(term) ? '' : 'none';
      }
    };
    q?.addEventListener('input', onFilter);
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === '/') { e.preventDefault(); q?.focus(); }
    });
  </script>
</Page>
