---
import RackLayout from "../../layouts/RackLayout.astro";
import { getCollection } from "astro:content";

const posts = (await getCollection("blog"))
  .filter(p => !p.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Group by year
const postsByYear = posts.reduce((acc, post) => {
  const year = new Date(post.data.pubDate).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<RackLayout 
  title="Blog" 
  description="System logs, technical writings, and thoughts from Bernard McWeeney"
>
  <!-- Header Blade -->
  <div class="blade" data-unit="1U">
    <div class="blade-face">
      <div class="led-cluster">
        <span class="led on"></span>
        <span class="led on blink"></span>
      </div>
      <span class="blade-label">
        BLOG LOGS
        <span class="model">/var/log/blog</span>
      </span>
      <div class="header-actions">
        <a href="/rss.xml" class="btn btn-sm btn-ghost">
          RSS ↗
        </a>
      </div>
    </div>
  </div>

  <!-- Terminal Header -->
  <div class="blade" data-unit="1U">
    <div class="blade-content" style="padding: 0.75rem;">
      <div class="terminal" style="border: none; background: transparent;">
        <div class="terminal-line">
          <span class="prompt">[bernard@srv01 ~]$</span>
          <span class="command">cat /var/log/blog/*.log | sort -r</span>
        </div>
        <div class="terminal-line">
          <span class="output muted">Displaying {posts.length} log entries...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Posts by Year -->
  {years.map(year => (
    <div class="blade" data-unit="2U">
      <div class="blade-face">
        <div class="led-cluster">
          <span class="led on"></span>
        </div>
        <span class="blade-label">
          {year}
          <span class="model">{postsByYear[Number(year)].length} entries</span>
        </span>
      </div>
      
      <div class="blade-content">
        <div class="log-list stagger">
          {postsByYear[Number(year)].map((post) => {
            const date = new Date(post.data.pubDate);
            return (
              <a href={`/blog/${post.slug}/`} class="log-row">
                <span class="log-led"></span>
                <span class="log-date">{date.toISOString().slice(5, 10)}</span>
                <span class="log-title">{post.data.title}</span>
                <span class="log-desc">{post.data.description}</span>
                <div class="log-tags">
                  {post.data.tags?.slice(0, 3).map(tag => (
                    <span class="badge">{tag}</span>
                  ))}
                </div>
              </a>
            );
          })}
        </div>
      </div>
    </div>
  ))}

  {posts.length === 0 && (
    <div class="blade" data-unit="2U">
      <div class="blade-content">
        <div class="empty-state">
          <span class="empty-icon">◌</span>
          <span class="empty-text">No log entries found</span>
          <span class="empty-sub">Check back soon for new posts</span>
        </div>
      </div>
    </div>
  )}
</RackLayout>

<style>
  .header-actions {
    margin-left: auto;
    display: flex;
    gap: 0.5rem;
  }

  .log-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .log-row {
    display: grid;
    grid-template-columns: auto 60px 200px 1fr auto;
    align-items: center;
    gap: 1rem;
    padding: 0.6rem 0.75rem;
    background: var(--color-panel);
    border: 1px solid var(--color-border);
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .log-row:hover {
    background: var(--color-surface);
    border-color: var(--color-term-green);
  }

  .log-led {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--color-term-green);
    box-shadow: var(--glow-green);
  }

  .log-date {
    font-size: 11px;
    color: var(--color-term-cyan);
    font-variant-numeric: tabular-nums;
  }

  .log-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--color-term-white);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .log-row:hover .log-title {
    color: var(--color-term-green);
  }

  .log-desc {
    font-size: 11px;
    color: var(--color-term-dark);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .log-tags {
    display: flex;
    gap: 4px;
  }

  @media (max-width: 900px) {
    .log-row {
      grid-template-columns: auto 50px 1fr;
    }
    .log-desc, .log-tags {
      display: none;
    }
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    text-align: center;
  }

  .empty-icon {
    font-size: 3rem;
    color: var(--color-term-dark);
    margin-bottom: 1rem;
  }

  .empty-text {
    font-size: 14px;
    color: var(--color-term-gray);
    margin-bottom: 0.5rem;
  }

  .empty-sub {
    font-size: 12px;
    color: var(--color-term-dark);
  }
</style>