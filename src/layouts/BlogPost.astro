---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';

type Props = CollectionEntry<'blog'>['data'];
const { title, description, pubDate, updatedDate, heroImage, tags = [], category } = Astro.props;
---

<html lang="en">
  <head>
    <BaseHead title={title} description={description} />
  </head>
  <body>
    <Header />

    <!-- Reading progress -->
    <div id="read-progress" style="position:sticky;top:0;height:4px;background:linear-gradient(90deg,var(--brand) var(--w,0%),transparent 0);z-index:50;"></div>

    <main class="container" style="max-width:72rem;padding:1rem 1rem 2rem;">
      <!-- Hero -->
      <section class="panel corners" style="margin-bottom:1rem;">
        <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>
        <div class="head">
          <div class="icon">md</div>
          <div class="font-mono text-sm">{title.toLowerCase().replace(/\s+/g,'_')}.md</div>
        </div>
        <div class="body" style="padding:1.25rem 1.25rem 0 1.25rem;">
          <div class="font-mono text-sm" style="color:var(--muted);">
            <FormattedDate date={pubDate} />
            {updatedDate && <> · updated <FormattedDate date={updatedDate} /></>}
            {category && <> · {category}</>}
          </div>
          <h1 style="margin:.4rem 0 0 0; font-size:clamp(2rem,3.5vw,2.6rem);">{title}<span class="caret-slash"></span></h1>
          {description && <p class="text-[color:var(--muted)]">{description}</p>}
        </div>
      </section>

      {heroImage && (
        <figure class="panel corners" style="margin:0 0 1rem 0; overflow:hidden;">
          <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>
          <img src={heroImage} alt={title} loading="lazy" style="display:block;width:100%;height:auto;" />
        </figure>
      )}

      <!-- Content + TOC -->
      <div class="grid" style="grid-template-columns:minmax(0,1fr) 260px; gap:16px;">
        <article id="post-article" class="panel corners" style="justify-self:start;">
          <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>

          <!-- BIG FIX: generous inner padding + centered readable measure -->
          <div class="body" style="padding:1.5rem;">
            <div class="prose" style="max-width:68ch;margin-inline:auto;">
              <slot />
            </div>
          </div>
        </article>

        <aside class="grid gap-4" style="position:sticky;top:64px;height:max-content;">
          <!-- On this page (built client-side) -->
          <section class="widget corners">
            <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>
            <div class="head"><div class="icon">≡</div><div class="font-mono text-sm">On this page</div></div>
            <div class="body">
              <nav id="toc" class="font-mono text-sm"></nav>
            </div>
          </section>

          {tags.length>0 && (
            <section class="panel corners">
              <span class="sq tl"></span><span class="sq tr"></span><span class="sq bl"></span><span class="sq br"></span>
              <div class="head"><div class="icon">#</div><div class="font-mono text-sm">Tags</div></div>
              <div class="body" style="padding: .9rem 1.25rem;">
                <div class="flex flex-wrap gap-2">
                  {tags.map((t:string)=><a class="badge" href={`/blog/tags/${encodeURIComponent(t.toLowerCase())}/`}>{t}</a>)}
                </div>
              </div>
            </section>
          )}
        </aside>
      </div>

      <!-- Footer nav -->
      <nav class="panel" style="margin-top:1rem;">
        <div class="body flex items-center justify-between" style="padding: .9rem 1.25rem;">
          <a href="/blog" class="font-mono no-underline hover:underline">← back to blog</a>
          <div class="font-mono text-sm text-[color:var(--muted)]">&gt; EOF</div>
        </div>
      </nav>
    </main>

    <Footer />

    <script>
      // Reading progress
      const prog = document.getElementById('read-progress');
      const art = document.getElementById('post-article');
      const onScroll = () => {
        if(!art) return;
        const total = art.scrollHeight - window.innerHeight;
        const read = Math.min(Math.max(window.scrollY - art.offsetTop, 0), total);
        const pct = total > 0 ? (read / total) * 100 : 0;
        prog && (prog.style.setProperty('--w', pct+'%'));
      };
      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll();

      // Build TOC from headings
      const toc = document.getElementById('toc');
      if (toc && art) {
        const hs = art.querySelectorAll('h2, h3');
        const ul = document.createElement('ul');
        ul.style.listStyle = 'none'; ul.style.margin='0'; ul.style.padding='0';
        hs.forEach((h) => {
          if (!h.id) h.id = h.textContent.toLowerCase().replace(/[^a-z0-9]+/g,'-');
          const li = document.createElement('li');
          li.style.padding = '.2rem 0';
          li.style.paddingLeft = h.tagName === 'H3' ? '1rem' : '0';
          const a = document.createElement('a');
          a.href = '#'+h.id; a.textContent = h.textContent; a.className = 'no-underline hover:underline';
          li.appendChild(a); ul.appendChild(li);
        });
        toc.appendChild(ul);
      }
    </script>
  </body>
</html>
