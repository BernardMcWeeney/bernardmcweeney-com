---
import HeaderLink from "./HeaderLink.astro";
---

<!-- Pre-init theme to avoid FOUC -->
<script is:inline>
  (function () {
    try {
      const stored = localStorage.getItem("theme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      const dark = stored ? stored === "dark" : prefersDark;
      document.documentElement.classList.toggle("dark", dark);
      document.documentElement.dataset.theme = dark ? "dark" : "light";
    } catch {}
  })();
</script>

<header class="sticky top-0 z-50 border-b border-[color:var(--border)] bg-[color:var(--paper)]/85 backdrop-blur supports-[backdrop-filter]:bg-[color:var(--paper)]/85">
  <div class="container">
    <nav class="flex items-center justify-between py-3">
      <!-- Brand title with blinking slash; keep on one line -->
      <a href="/" class="inline-flex items-center gap-3 no-underline">
        <div class="panel px-3 py-2 font-mono text-[15px] leading-none whitespace-nowrap">
          Bernard_McWeeney<span class="caret-slash" aria-hidden="true"></span>
        </div>
      </a>

      <!-- Desktop nav -->
      <div class="hidden md:flex items-center gap-2">
        <!-- Home is just a slash -->
        <HeaderLink href="/" class="btn" aria-label="home">/</HeaderLink>
        <HeaderLink href="/about/" class="btn">about</HeaderLink>
        <HeaderLink href="/blog/" class="btn">blog</HeaderLink>
        <HeaderLink href="/projects/" class="btn">projects</HeaderLink>
        <HeaderLink href="/notes/" class="btn">notes</HeaderLink>
        <HeaderLink href="/archive/" class="btn">archive</HeaderLink>

        <!-- Sun/Moon theme toggle -->
        <button id="theme-toggle" class="btn ml-2" aria-label="Toggle theme" title="Toggle theme">
          <!-- Moon (shown in light mode) -->
          <svg id="icon-moon" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
          </svg>
          <!-- Sun (shown in dark mode) -->
          <svg id="icon-sun" class="w-5 h-5 hidden" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 7a5 5 0 100 10 5 5 0 000-10zm0-4a1 1 0 011-1 1 1 0 110 2 1 1 0 01-1-1zm0 18a1 1 0 011 1 1 1 0 11-2 0 1 1 0 011-1zm9-9a1 1 0 011 1 1 1 0 11-2 0 1 1 0 011-1zM5 12a1 1 0 011 1 1 1 0 11-2 0 1 1 0 011-1zM18.364 5.636a1 1 0 111.414 1.414 1 1 0 11-1.414-1.414zM6.222 17.778a1 1 0 111.414 1.414 1 1 0 11-1.414-1.414zM18.778 17.778a1 1 0 011.414 1.414 1 1 0 11-1.414-1.414zM6.222 6.222a1 1 0 111.414-1.414 1 1 0 11-1.414 1.414z"/>
          </svg>
        </button>
      </div>

      <!-- Mobile trigger -->
      <button id="nav-toggle" class="md:hidden btn" aria-label="Toggle menu">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
        </svg>
      </button>
    </nav>

    <!-- Mobile drawer -->
    <div id="nav-drawer" class="md:hidden hidden pb-3">
      <div class="panel p-2 grid gap-2">
        <HeaderLink href="/" class="btn" aria-label="home">/</HeaderLink>
        <HeaderLink href="/about/" class="btn">about</HeaderLink>
        <HeaderLink href="/blog/" class="btn">blog</HeaderLink>
        <HeaderLink href="/projects/" class="btn">projects</HeaderLink>
        <HeaderLink href="/notes/" class="btn">notes</HeaderLink>
        <HeaderLink href="/archive/" class="btn">archive</HeaderLink>
        <button id="theme-toggle-mobile" class="btn">toggle theme</button>
      </div>
    </div>
  </div>
</header>

<script is:inline>
  const drawer = document.getElementById('nav-drawer');
  const toggle = document.getElementById('nav-toggle');
  toggle?.addEventListener('click', () => drawer?.classList.toggle('hidden'));

  const root = document.documentElement;
  const sun = document.getElementById('icon-sun');
  const moon = document.getElementById('icon-moon');

  function applyTheme(dark) {
    root.classList.toggle('dark', dark);
    root.dataset.theme = dark ? 'dark' : 'light';
    localStorage.setItem('theme', dark ? 'dark' : 'light');
    if (sun && moon) {
      sun.classList.toggle('hidden', !dark); // show sun in dark mode
      moon.classList.toggle('hidden', dark); // show moon in light mode
    }
  }
  function isDark() { return root.classList.contains('dark'); }

  document.getElementById('theme-toggle')?.addEventListener('click', () => applyTheme(!isDark()));
  document.getElementById('theme-toggle-mobile')?.addEventListener('click', () => applyTheme(!isDark()));

  try {
    if (!localStorage.getItem('theme')) {
      const mql = window.matchMedia('(prefers-color-scheme: dark)');
      mql.addEventListener?.('change', e => applyTheme(e.matches));
    }
  } catch {}

  // sync icons on first paint
  (function syncIcons() { applyTheme(isDark()); })();
</script>
