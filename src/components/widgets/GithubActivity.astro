---
/**
 * GitHub Activity Widget
 * Shows recent GitHub activity with contribution graph animation
 */

interface Props {
  username?: string;
}

const { username = "BernardMcWeeney" } = Astro.props;
---

<section class="widget" data-github-activity data-username={username}>
  <div class="widget-header">
    <span class="widget-icon">⌨</span>
    <span>GitHub</span>
    <a href={`https://github.com/${username}`} target="_blank" rel="noopener" class="ml-auto text-xs text-[var(--color-text-muted)] hover:text-[var(--color-brand)]">
      @{username} ↗
    </a>
  </div>

  <div class="widget-body">
    <div class="flex items-start gap-4">
      <!-- Mini contribution graph -->
      <div class="contrib-graph" aria-hidden="true">
        <div class="graph-grid" id="contrib-grid">
          <!-- 7 rows x 12 cols = 84 cells (about 12 weeks) -->
          {Array.from({ length: 84 }).map((_, i) => (
            <div class="graph-cell" data-level="0"></div>
          ))}
        </div>
        <div class="graph-legend">
          <span>Less</span>
          <div class="legend-cells">
            <div class="graph-cell" data-level="0"></div>
            <div class="graph-cell" data-level="1"></div>
            <div class="graph-cell" data-level="2"></div>
            <div class="graph-cell" data-level="3"></div>
            <div class="graph-cell" data-level="4"></div>
          </div>
          <span>More</span>
        </div>
      </div>

      <!-- Activity info -->
      <div class="flex-1 min-w-0">
        <div class="flex items-baseline gap-2">
          <span id="contrib-count" class="font-mono text-2xl font-bold text-[var(--color-brand)]">--</span>
          <span class="text-xs text-[var(--color-text-muted)]">contributions</span>
        </div>
        <p class="text-xs text-[var(--color-text-muted)] mt-1">in the last 12 weeks</p>
        
        <!-- Recent repo -->
        <div class="mt-3 p-2 rounded bg-[var(--color-bg-elevated)] border border-[var(--color-border)]">
          <p class="text-xs text-[var(--color-text-muted)]">Latest activity</p>
          <p id="latest-repo" class="font-mono text-sm text-[var(--color-text-primary)] truncate mt-0.5">
            Loading...
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .contrib-graph {
    flex-shrink: 0;
    width: 100px;
  }

  .graph-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-template-rows: repeat(7, 1fr);
    gap: 2px;
  }

  .graph-cell {
    width: 6px;
    height: 6px;
    border-radius: 1px;
    background: var(--color-bg-elevated);
    transition: background 0.3s ease, transform 0.2s ease;
  }

  .graph-cell[data-level="1"] { background: color-mix(in oklab, var(--color-brand) 25%, var(--color-bg-elevated)); }
  .graph-cell[data-level="2"] { background: color-mix(in oklab, var(--color-brand) 50%, var(--color-bg-elevated)); }
  .graph-cell[data-level="3"] { background: color-mix(in oklab, var(--color-brand) 75%, var(--color-bg-elevated)); }
  .graph-cell[data-level="4"] { background: var(--color-brand); box-shadow: 0 0 4px var(--color-brand); }

  .graph-cell:hover {
    transform: scale(1.3);
  }

  .graph-legend {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 6px;
    font-size: 8px;
    color: var(--color-text-dimmed);
  }

  .legend-cells {
    display: flex;
    gap: 2px;
  }

  .legend-cells .graph-cell {
    width: 8px;
    height: 8px;
  }
</style>

<script>
  const container = document.querySelector('[data-github-activity]');
  if (container) {
    const username = container.getAttribute('data-username') || 'BernardMcWeeney';
    const cells = container.querySelectorAll('.graph-grid .graph-cell');
    const contribCount = container.querySelector('#contrib-count') as HTMLElement;
    const latestRepo = container.querySelector('#latest-repo') as HTMLElement;

    // Simulate contribution data (GitHub API requires auth for real data)
    function generateFakeContributions() {
      const data: number[] = [];
      let total = 0;
      
      for (let i = 0; i < 84; i++) {
        // Higher chance of contributions on weekdays
        const dayOfWeek = i % 7;
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        
        let level = 0;
        const rand = Math.random();
        
        if (isWeekend) {
          if (rand > 0.7) level = 1;
          if (rand > 0.9) level = 2;
        } else {
          if (rand > 0.3) level = 1;
          if (rand > 0.5) level = 2;
          if (rand > 0.7) level = 3;
          if (rand > 0.9) level = 4;
        }
        
        data.push(level);
        total += level * 2; // Rough estimate
      }
      
      return { data, total };
    }

    // Animate the grid
    function animateGrid() {
      const { data, total } = generateFakeContributions();
      
      cells.forEach((cell, i) => {
        setTimeout(() => {
          (cell as HTMLElement).setAttribute('data-level', String(data[i]));
        }, i * 10); // Stagger animation
      });
      
      // Animate count
      let current = 0;
      const increment = Math.ceil(total / 30);
      const countInterval = setInterval(() => {
        current += increment;
        if (current >= total) {
          current = total;
          clearInterval(countInterval);
        }
        contribCount.textContent = String(current);
      }, 30);
    }

    // Try to fetch real public event
    async function fetchLatestActivity() {
      try {
        const response = await fetch(`https://api.github.com/users/${username}/events/public?per_page=1`);
        if (!response.ok) throw new Error('Failed to fetch');
        const events = await response.json();
        
        if (events.length > 0) {
          const event = events[0];
          const repoName = event.repo?.name?.split('/')[1] || event.repo?.name || 'Unknown';
          const type = event.type?.replace('Event', '') || 'Activity';
          latestRepo.textContent = `${type} on ${repoName}`;
        } else {
          latestRepo.textContent = 'No recent activity';
        }
      } catch {
        latestRepo.textContent = 'Unable to fetch';
      }
    }

    // Initialize
    animateGrid();
    fetchLatestActivity();
  }
</script>