---
/**
 * Weather Widget
 * Features an animated thermometer with mercury effect
 * Displays current weather with location detection
 */
---

<section class="widget" data-weather>
  <div class="widget-header">
    <span class="widget-icon">üå§</span>
    <span>Weather</span>
    <span id="weather-updated" class="ml-auto text-xs opacity-60">--</span>
  </div>

  <div class="widget-body">
    <div class="flex items-center gap-5">
      <!-- Thermometer -->
      <div class="thermometer-container" aria-hidden="true">
        <div class="thermometer">
          <!-- Scale markings -->
          <div class="thermo-scale">
            <span class="scale-mark" style="bottom: 100%">40¬∞</span>
            <span class="scale-mark" style="bottom: 75%">30¬∞</span>
            <span class="scale-mark" style="bottom: 50%">20¬∞</span>
            <span class="scale-mark" style="bottom: 25%">10¬∞</span>
            <span class="scale-mark" style="bottom: 0%">0¬∞</span>
          </div>
          
          <!-- Tube -->
          <div class="thermo-tube">
            <div class="thermo-glass">
              <!-- Mercury column -->
              <div id="mercury" class="mercury">
                <div class="mercury-shine"></div>
              </div>
              <!-- Temperature ticks -->
              <div class="thermo-ticks"></div>
            </div>
          </div>
          
          <!-- Bulb -->
          <div class="thermo-bulb">
            <div class="bulb-inner">
              <div class="bulb-shine"></div>
            </div>
          </div>
        </div>
        
        <!-- Condition icon -->
        <div id="weather-icon" class="weather-icon">‚òÄÔ∏è</div>
      </div>

      <!-- Weather Info -->
      <div class="flex-1 min-w-0">
        <p id="weather-location" class="font-mono text-sm font-medium text-[var(--color-text-primary)] truncate">
          Detecting location...
        </p>
        
        <div class="flex items-baseline gap-2 mt-1">
          <span id="weather-temp" class="font-mono text-4xl font-bold text-[var(--color-text-primary)] tabular-nums">
            --
          </span>
          <span class="text-lg text-[var(--color-text-muted)]">¬∞C</span>
        </div>
        
        <p id="weather-desc" class="text-sm text-[var(--color-text-secondary)] mt-1">
          ‚Äî
        </p>
        
        <!-- Weather details -->
        <div class="flex gap-4 mt-3 text-xs text-[var(--color-text-muted)]">
          <span id="weather-feels" class="flex items-center gap-1">
            <span class="text-[var(--color-brand)]">‚óè</span>
            Feels like --¬∞
          </span>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Thermometer Container */
  .thermometer-container {
    position: relative;
    width: 60px;
    height: 100px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .thermometer {
    position: relative;
    width: 100%;
    height: 85px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Scale */
  .thermo-scale {
    position: absolute;
    left: 0;
    top: 8px;
    bottom: 20px;
    width: 20px;
  }

  .scale-mark {
    position: absolute;
    right: 4px;
    font-family: var(--font-family-mono);
    font-size: 7px;
    color: var(--color-text-dimmed);
    transform: translateY(50%);
  }

  /* Tube */
  .thermo-tube {
    position: relative;
    width: 16px;
    height: 60px;
    margin-left: 10px;
  }

  .thermo-glass {
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, 
      rgba(255,255,255,0.1) 0%, 
      rgba(255,255,255,0.2) 30%,
      rgba(255,255,255,0.1) 70%,
      rgba(255,255,255,0.05) 100%
    );
    border: 2px solid var(--color-border-strong);
    border-radius: 8px 8px 0 0;
    overflow: hidden;
  }

  /* Mercury */
  .mercury {
    position: absolute;
    bottom: 0;
    left: 2px;
    right: 2px;
    height: 0%;
    background: linear-gradient(90deg, 
      #c42d2d 0%, 
      #ff4d4d 30%,
      #ff6b6b 50%,
      #ff4d4d 70%,
      #c42d2d 100%
    );
    border-radius: 4px 4px 0 0;
    transition: height 1s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 
      inset 0 2px 4px rgba(255,255,255,0.3),
      0 0 8px rgba(255, 77, 77, 0.3);
  }

  .mercury.hot {
    background: linear-gradient(90deg, 
      #c42d2d 0%, 
      #ff4d4d 30%,
      var(--color-brand) 50%,
      #ff4d4d 70%,
      #c42d2d 100%
    );
    box-shadow: 
      inset 0 2px 4px rgba(255,255,255,0.3),
      0 0 12px var(--color-brand);
  }

  .mercury.cold {
    background: linear-gradient(90deg, 
      #2563eb 0%, 
      #3b82f6 30%,
      #60a5fa 50%,
      #3b82f6 70%,
      #2563eb 100%
    );
    box-shadow: 
      inset 0 2px 4px rgba(255,255,255,0.3),
      0 0 8px rgba(59, 130, 246, 0.3);
  }

  .mercury-shine {
    position: absolute;
    top: 0;
    left: 1px;
    width: 2px;
    height: 100%;
    background: linear-gradient(180deg, 
      rgba(255,255,255,0.4) 0%,
      rgba(255,255,255,0.1) 100%
    );
    border-radius: 2px;
  }

  /* Ticks */
  .thermo-ticks {
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent 0px,
      transparent 5px,
      rgba(255,255,255,0.1) 5px,
      rgba(255,255,255,0.1) 6px
    );
    pointer-events: none;
  }

  /* Bulb */
  .thermo-bulb {
    position: relative;
    width: 24px;
    height: 24px;
    margin-top: -2px;
    margin-left: 10px;
    background: linear-gradient(145deg, 
      var(--color-border-strong), 
      var(--color-border)
    );
    border-radius: 50%;
    border: 2px solid var(--color-border-strong);
  }

  .bulb-inner {
    position: absolute;
    inset: 3px;
    background: linear-gradient(135deg, 
      #ff6b6b 0%, 
      #c42d2d 100%
    );
    border-radius: 50%;
    transition: background 1s ease;
    box-shadow: inset 0 -2px 4px rgba(0,0,0,0.3);
  }

  .bulb-inner.hot {
    background: linear-gradient(135deg, 
      var(--color-brand-hover) 0%, 
      var(--color-brand) 100%
    );
    box-shadow: 
      inset 0 -2px 4px rgba(0,0,0,0.3),
      0 0 12px var(--color-brand);
  }

  .bulb-inner.cold {
    background: linear-gradient(135deg, 
      #60a5fa 0%, 
      #2563eb 100%
    );
  }

  .bulb-shine {
    position: absolute;
    top: 2px;
    left: 3px;
    width: 6px;
    height: 6px;
    background: rgba(255,255,255,0.4);
    border-radius: 50%;
  }

  /* Weather Icon */
  .weather-icon {
    position: absolute;
    bottom: 0;
    right: 0;
    font-size: 20px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    animation: weather-bob 3s ease-in-out infinite;
  }

  @keyframes weather-bob {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .mercury { transition: height 0.1s ease; }
    .weather-icon { animation: none; }
  }
</style>

<script>
  const container = document.querySelector('[data-weather]');
  if (container) {
    const locationEl = container.querySelector('#weather-location') as HTMLElement;
    const tempEl = container.querySelector('#weather-temp') as HTMLElement;
    const descEl = container.querySelector('#weather-desc') as HTMLElement;
    const feelsEl = container.querySelector('#weather-feels') as HTMLElement;
    const updatedEl = container.querySelector('#weather-updated') as HTMLElement;
    const mercuryEl = container.querySelector('#mercury') as HTMLElement;
    const bulbEl = container.querySelector('.bulb-inner') as HTMLElement;
    const iconEl = container.querySelector('#weather-icon') as HTMLElement;

    const weatherCodes: Record<number, { desc: string; icon: string }> = {
      0: { desc: 'Clear sky', icon: '‚òÄÔ∏è' },
      1: { desc: 'Mainly clear', icon: 'üå§' },
      2: { desc: 'Partly cloudy', icon: '‚õÖ' },
      3: { desc: 'Overcast', icon: '‚òÅÔ∏è' },
      45: { desc: 'Fog', icon: 'üå´' },
      48: { desc: 'Depositing rime fog', icon: 'üå´' },
      51: { desc: 'Light drizzle', icon: 'üåß' },
      53: { desc: 'Drizzle', icon: 'üåß' },
      55: { desc: 'Dense drizzle', icon: 'üåß' },
      61: { desc: 'Slight rain', icon: 'üå¶' },
      63: { desc: 'Rain', icon: 'üåß' },
      65: { desc: 'Heavy rain', icon: '‚õà' },
      71: { desc: 'Slight snow', icon: 'üå®' },
      73: { desc: 'Snow', icon: '‚ùÑÔ∏è' },
      75: { desc: 'Heavy snow', icon: '‚ùÑÔ∏è' },
      77: { desc: 'Snow grains', icon: 'üå®' },
      80: { desc: 'Slight showers', icon: 'üå¶' },
      81: { desc: 'Showers', icon: 'üåß' },
      82: { desc: 'Violent showers', icon: '‚õà' },
      85: { desc: 'Slight snow showers', icon: 'üå®' },
      86: { desc: 'Heavy snow showers', icon: '‚ùÑÔ∏è' },
      95: { desc: 'Thunderstorm', icon: '‚õà' },
      96: { desc: 'Thunderstorm with slight hail', icon: '‚õà' },
      99: { desc: 'Thunderstorm with heavy hail', icon: '‚õà' },
    };

    function setTemperature(temp: number) {
      // Map -10¬∞C to 40¬∞C ‚Üí 0% to 100%
      const percent = Math.max(0, Math.min(100, ((temp + 10) / 50) * 100));
      mercuryEl.style.height = `${percent}%`;
      tempEl.textContent = Math.round(temp).toString();

      // Color based on temperature
      mercuryEl.classList.remove('hot', 'cold');
      bulbEl.classList.remove('hot', 'cold');
      
      if (temp >= 25) {
        mercuryEl.classList.add('hot');
        bulbEl.classList.add('hot');
      } else if (temp <= 5) {
        mercuryEl.classList.add('cold');
        bulbEl.classList.add('cold');
      }
    }

    async function reverseGeocode(lat: number, lon: number): Promise<string | null> {
      try {
        const response = await fetch(
          `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en&format=json`
        );
        const data = await response.json();
        const place = data?.results?.[0];
        if (!place) return null;
        
        const name = place.city || place.town || place.village || place.name || '';
        const country = place.country_code?.toUpperCase() || '';
        return name ? `${name}, ${country}` : place.country || null;
      } catch {
        return null;
      }
    }

    async function fetchWeather(lat: number, lon: number, fallbackLabel: string) {
      try {
        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,weather_code&timezone=auto`
        );
        const data = await response.json();
        const temp = data?.current?.temperature_2m;
        const feelsLike = data?.current?.apparent_temperature;
        const code = data?.current?.weather_code;

        const location = await reverseGeocode(lat, lon);
        locationEl.textContent = location || fallbackLabel;
        setTemperature(temp);
        
        const weather = weatherCodes[code] || { desc: 'Unknown', icon: 'üå°' };
        descEl.textContent = weather.desc;
        iconEl.textContent = weather.icon;
        feelsEl.innerHTML = `<span class="text-[var(--color-brand)]">‚óè</span> Feels like ${Math.round(feelsLike)}¬∞`;
        
        // Update timestamp
        const now = new Date();
        updatedEl.textContent = now.toLocaleTimeString('en-IE', { hour: '2-digit', minute: '2-digit' });
      } catch {
        locationEl.textContent = 'Weather unavailable';
        descEl.textContent = 'Unable to fetch data';
      }
    }

    // Default to Dublin, Ireland
    const DEFAULT_LAT = 53.3498;
    const DEFAULT_LON = -6.2603;

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => fetchWeather(pos.coords.latitude, pos.coords.longitude, 'Your location'),
        () => fetchWeather(DEFAULT_LAT, DEFAULT_LON, 'Dublin, IE'),
        { timeout: 4000 }
      );
    } else {
      fetchWeather(DEFAULT_LAT, DEFAULT_LON, 'Dublin, IE');
    }

    // Refresh every 10 minutes
    setInterval(() => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => fetchWeather(pos.coords.latitude, pos.coords.longitude, 'Your location'),
          () => fetchWeather(DEFAULT_LAT, DEFAULT_LON, 'Dublin, IE'),
          { timeout: 4000 }
        );
      }
    }, 600000);
  }
</script>