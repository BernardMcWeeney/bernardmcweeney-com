---
/**
 * Irish Map Widget
 * Shows Ireland with animated city markers and user location
 * Highlights connection point with pulse animation
 */

interface Props {
  showCities?: boolean;
}

const { showCities = true } = Astro.props;

const cities = [
  { name: "Dublin", lat: 53.3498, lon: -6.2603, x: 78, y: 42, size: "lg" },
  { name: "Cork", lat: 51.8985, lon: -8.4756, x: 52, y: 86, size: "md" },
  { name: "Galway", lat: 53.2707, lon: -9.0568, x: 28, y: 52, size: "md" },
  { name: "Limerick", lat: 52.6638, lon: -8.6267, x: 42, y: 68, size: "sm" },
  { name: "Waterford", lat: 52.2593, lon: -7.1101, x: 62, y: 82, size: "sm" },
  { name: "Belfast", lat: 54.5973, lon: -5.9301, x: 82, y: 20, size: "md" },
  { name: "Sligo", lat: 54.2697, lon: -8.4601, x: 32, y: 26, size: "sm" },
  { name: "Killarney", lat: 52.0599, lon: -9.5044, x: 30, y: 78, size: "sm" },
];
---

<section class="widget overflow-visible" data-irish-map>
  <div class="widget-header">
    <span class="widget-icon">üáÆüá™</span>
    <span>Location</span>
    <span id="map-status" class="ml-auto text-xs text-[var(--color-text-muted)]">Locating...</span>
  </div>

  <div class="map-container">
    <!-- Ireland SVG Map -->
    <svg class="ireland-map" viewBox="0 0 100 120" preserveAspectRatio="xMidYMid meet">
      <defs>
        <!-- Glow filter for markers -->
        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
          <feMerge>
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        
        <!-- Gradient for Ireland -->
        <linearGradient id="ireland-fill" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:var(--color-bg-elevated)"/>
          <stop offset="100%" style="stop-color:var(--color-bg-overlay)"/>
        </linearGradient>
      </defs>
      
      <!-- Simplified Ireland outline -->
      <path 
        class="ireland-outline"
        d="M75,15 
           C82,12 88,18 85,25 
           L87,35 C90,40 88,48 82,52
           L80,65 C78,75 75,82 72,88
           C68,95 60,100 52,98
           L45,95 C38,92 32,88 28,82
           C22,74 18,65 20,55
           L18,45 C15,38 18,30 25,25
           C30,20 38,18 45,15
           C52,12 62,10 70,12
           Z"
        fill="url(#ireland-fill)"
        stroke="var(--color-border-strong)"
        stroke-width="1"
      />
      
      <!-- Northern Ireland border (subtle) -->
      <path 
        class="ni-border"
        d="M65,20 C70,22 75,20 78,25 L80,35"
        fill="none"
        stroke="var(--color-border)"
        stroke-width="0.5"
        stroke-dasharray="2 2"
        opacity="0.5"
      />
    </svg>

    <!-- City Markers -->
    {showCities && cities.map((city, i) => (
      <div 
        class={`city-marker city-marker--${city.size}`}
        style={`left: ${city.x}%; top: ${city.y}%;`}
        data-city={city.name}
        data-lat={city.lat}
        data-lon={city.lon}
        title={city.name}
      >
        <span class="marker-dot"></span>
        <span class="marker-label">{city.name}</span>
      </div>
    ))}

    <!-- User Location Marker -->
    <div id="user-marker" class="user-marker hidden">
      <span class="user-pulse"></span>
      <span class="user-dot"></span>
    </div>

    <!-- Connection Line -->
    <svg id="connection-line" class="connection-svg hidden">
      <line class="connection-path" x1="0" y1="0" x2="0" y2="0" />
    </svg>

    <!-- Info Panel -->
    <div id="map-info" class="map-info">
      <p class="info-title">üìç Detecting...</p>
      <p class="info-detail">Finding your location</p>
    </div>
  </div>
</section>

<style>
  .map-container {
    position: relative;
    height: 180px;
    overflow: hidden;
    background: 
      radial-gradient(circle at 70% 30%, rgba(249, 115, 22, 0.05) 0%, transparent 50%),
      var(--color-bg-base);
  }

  .ireland-map {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 85%;
    height: 85%;
    opacity: 0.9;
  }

  .ireland-outline {
    transition: fill 0.3s ease;
  }

  /* City Markers */
  .city-marker {
    position: absolute;
    transform: translate(-50%, -50%);
    z-index: 2;
    cursor: pointer;
  }

  .marker-dot {
    display: block;
    background: var(--color-border-strong);
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .city-marker--lg .marker-dot { width: 8px; height: 8px; }
  .city-marker--md .marker-dot { width: 6px; height: 6px; }
  .city-marker--sm .marker-dot { width: 4px; height: 4px; }

  .city-marker:hover .marker-dot,
  .city-marker.active .marker-dot {
    background: var(--color-brand);
    box-shadow: 0 0 8px var(--color-brand);
    transform: scale(1.3);
  }

  .marker-label {
    position: absolute;
    left: 50%;
    top: 100%;
    transform: translateX(-50%);
    margin-top: 4px;
    font-family: var(--font-family-mono);
    font-size: 8px;
    color: var(--color-text-dimmed);
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
  }

  .city-marker:hover .marker-label,
  .city-marker.active .marker-label {
    opacity: 1;
    color: var(--color-text-secondary);
  }

  /* User Location Marker */
  .user-marker {
    position: absolute;
    transform: translate(-50%, -50%);
    z-index: 10;
  }

  .user-marker.hidden {
    display: none;
  }

  .user-dot {
    display: block;
    width: 12px;
    height: 12px;
    background: var(--color-brand);
    border: 2px solid var(--color-bg-surface);
    border-radius: 50%;
    box-shadow: 0 0 12px var(--color-brand);
    position: relative;
    z-index: 2;
  }

  .user-pulse {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 30px;
    height: 30px;
    background: var(--color-brand);
    border-radius: 50%;
    opacity: 0;
    animation: pulse-ring 2s ease-out infinite;
  }

  @keyframes pulse-ring {
    0% {
      transform: translate(-50%, -50%) scale(0.3);
      opacity: 0.6;
    }
    100% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 0;
    }
  }

  /* Connection Line */
  .connection-svg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5;
  }

  .connection-svg.hidden {
    display: none;
  }

  .connection-path {
    stroke: var(--color-brand);
    stroke-width: 1.5;
    stroke-dasharray: 4 2;
    stroke-linecap: round;
    opacity: 0.6;
    animation: dash-flow 1s linear infinite;
  }

  @keyframes dash-flow {
    to {
      stroke-dashoffset: -6;
    }
  }

  /* Info Panel */
  .map-info {
    position: absolute;
    left: 8px;
    bottom: 8px;
    background: var(--color-bg-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    max-width: 160px;
    z-index: 20;
  }

  .info-title {
    font-family: var(--font-family-mono);
    font-size: 11px;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0;
  }

  .info-detail {
    font-size: 10px;
    color: var(--color-text-muted);
    margin: 2px 0 0 0;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .user-pulse { animation: none; opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
    .connection-path { animation: none; }
  }
</style>

<script>
  const container = document.querySelector('[data-irish-map]');
  if (container) {
    const userMarker = container.querySelector('#user-marker') as HTMLElement;
    const connectionLine = container.querySelector('#connection-line') as SVGElement;
    const connectionPath = container.querySelector('.connection-path') as SVGLineElement;
    const mapStatus = container.querySelector('#map-status') as HTMLElement;
    const mapInfo = container.querySelector('#map-info') as HTMLElement;
    const infoTitle = container.querySelector('.info-title') as HTMLElement;
    const infoDetail = container.querySelector('.info-detail') as HTMLElement;
    const cityMarkers = container.querySelectorAll('.city-marker');

    // Ireland bounds
    const bounds = {
      minLat: 51.39,
      maxLat: 55.38,
      minLon: -10.47,
      maxLon: -5.43
    };

    function latLonToPercent(lat: number, lon: number) {
      const x = ((lon - bounds.minLon) / (bounds.maxLon - bounds.minLon)) * 100;
      const y = ((bounds.maxLat - lat) / (bounds.maxLat - bounds.minLat)) * 100;
      return {
        x: Math.max(5, Math.min(95, x)),
        y: Math.max(5, Math.min(95, y))
      };
    }

    function haversineDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {
      const R = 6371; // km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function findNearestCity(lat: number, lon: number) {
      let nearest = { name: 'Ireland', distance: Infinity, marker: null as HTMLElement | null };
      
      cityMarkers.forEach((marker) => {
        const cityLat = parseFloat(marker.getAttribute('data-lat') || '0');
        const cityLon = parseFloat(marker.getAttribute('data-lon') || '0');
        const distance = haversineDistance(lat, lon, cityLat, cityLon);
        
        if (distance < nearest.distance) {
          nearest = {
            name: marker.getAttribute('data-city') || 'Unknown',
            distance,
            marker: marker as HTMLElement
          };
        }
      });
      
      return nearest;
    }

    function placeUser(lat: number, lon: number) {
      const pos = latLonToPercent(lat, lon);
      
      // Show user marker
      userMarker.style.left = `${pos.x}%`;
      userMarker.style.top = `${pos.y}%`;
      userMarker.classList.remove('hidden');
      
      // Find nearest city
      const nearest = findNearestCity(lat, lon);
      
      // Highlight nearest city
      cityMarkers.forEach(m => m.classList.remove('active'));
      if (nearest.marker) {
        nearest.marker.classList.add('active');
        
        // Draw connection line
        const markerRect = nearest.marker.getBoundingClientRect();
        const containerRect = (container.querySelector('.map-container') as HTMLElement).getBoundingClientRect();
        
        const cityX = ((markerRect.left + markerRect.width/2) - containerRect.left) / containerRect.width * 100;
        const cityY = ((markerRect.top + markerRect.height/2) - containerRect.top) / containerRect.height * 100;
        
        connectionPath.setAttribute('x1', `${pos.x}%`);
        connectionPath.setAttribute('y1', `${pos.y}%`);
        connectionPath.setAttribute('x2', `${cityX}%`);
        connectionPath.setAttribute('y2', `${cityY}%`);
        connectionLine.classList.remove('hidden');
      }
      
      // Update info
      mapStatus.textContent = 'üü¢ Connected';
      infoTitle.textContent = `üìç Near ${nearest.name}`;
      infoDetail.textContent = `~${Math.round(nearest.distance)} km away`;
    }

    function handleError() {
      mapStatus.textContent = 'üìç Dublin (default)';
      infoTitle.textContent = 'üìç Dublin, IE';
      infoDetail.textContent = 'Location unavailable';
      
      // Default to Dublin
      placeUser(53.3498, -6.2603);
    }

    // Get user location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => placeUser(pos.coords.latitude, pos.coords.longitude),
        handleError,
        { timeout: 5000, enableHighAccuracy: false }
      );
    } else {
      handleError();
    }

    // Add hover effects for cities
    cityMarkers.forEach((marker) => {
      marker.addEventListener('mouseenter', () => {
        const name = marker.getAttribute('data-city');
        if (!marker.classList.contains('active')) {
          infoTitle.textContent = `üìå ${name}`;
          infoDetail.textContent = 'Major city';
        }
      });
      
      marker.addEventListener('mouseleave', () => {
        const active = container.querySelector('.city-marker.active');
        if (active) {
          const activeName = active.getAttribute('data-city');
          infoTitle.textContent = `üìç Near ${activeName}`;
        }
      });
    });
  }
</script>