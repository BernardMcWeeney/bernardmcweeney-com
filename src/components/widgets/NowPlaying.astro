---
/**
 * Now Playing Widget
 * Features a realistic turntable with spinning vinyl, tonearm, and controls
 * Displays currently playing track from Last.fm
 */
---

<section class="widget" data-now-playing>
  <div class="widget-header">
    <span class="widget-icon">â™«</span>
    <span>Now Playing</span>
    <span id="np-status" class="ml-auto flex items-center gap-1.5 text-xs">
      <span class="status-led"></span>
      <span class="status-text">Idle</span>
    </span>
  </div>

  <div class="widget-body">
    <div class="flex items-center gap-5">
      <!-- Turntable -->
      <div class="turntable" aria-hidden="true">
        <!-- Base/Deck -->
        <div class="deck">
          <!-- Platter -->
          <div class="platter">
            <!-- Vinyl Record -->
            <div id="vinyl" class="vinyl">
              <div class="vinyl-grooves"></div>
              <div class="vinyl-shine"></div>
              <div id="vinyl-label" class="vinyl-label">
                <div class="label-ring"></div>
              </div>
              <div class="vinyl-spindle"></div>
            </div>
          </div>
          
          <!-- Tonearm -->
          <div id="tonearm" class="tonearm">
            <div class="tonearm-base"></div>
            <div class="tonearm-arm">
              <div class="tonearm-head">
                <div class="tonearm-cartridge"></div>
              </div>
            </div>
          </div>
          
          <!-- Controls -->
          <div class="deck-controls">
            <button id="power-btn" class="power-btn" title="Power">
              <span class="power-led"></span>
            </button>
            <div class="speed-selector">
              <span class="speed-dot active"></span>
              <span class="speed-label">33</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Track Info -->
      <div class="flex-1 min-w-0">
        <a 
          id="np-link" 
          href="#" 
          target="_blank" 
          rel="noopener noreferrer"
          class="block group"
        >
          <p id="np-title" class="font-mono text-sm font-semibold text-[var(--color-text-primary)] truncate group-hover:text-[var(--color-brand)] transition-colors">
            Nothing playing
          </p>
        </a>
        <p id="np-artist" class="text-sm text-[var(--color-text-secondary)] truncate mt-0.5">
          â€”
        </p>
        <p id="np-album" class="text-xs text-[var(--color-text-muted)] truncate mt-0.5">
          â€”
        </p>
        
        <!-- Fake EQ Bars -->
        <div id="eq-bars" class="eq-container mt-3">
          <div class="eq-bar"></div>
          <div class="eq-bar"></div>
          <div class="eq-bar"></div>
          <div class="eq-bar"></div>
          <div class="eq-bar"></div>
          <div class="eq-bar"></div>
          <div class="eq-bar"></div>
          <div class="eq-bar"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Turntable Container */
  .turntable {
    width: 110px;
    height: 90px;
    flex-shrink: 0;
  }

  /* Deck Base */
  .deck {
    position: relative;
    width: 100%;
    height: 100%;
    background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
    border-radius: 6px;
    border: 1px solid var(--color-border);
    padding: 8px;
    box-shadow: 
      inset 0 1px 0 rgba(255,255,255,0.05),
      0 4px 12px rgba(0,0,0,0.4);
  }

  /* Platter */
  .platter {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 60px;
    height: 60px;
    background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
    border-radius: 50%;
    border: 2px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Vinyl */
  .vinyl {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #1a1a1a, #0a0a0a);
    position: relative;
    transition: transform 0.3s ease;
  }

  .vinyl.spinning {
    animation: spin-vinyl 1.8s linear infinite;
  }

  @keyframes spin-vinyl {
    to { transform: rotate(360deg); }
  }

  .vinyl-grooves {
    position: absolute;
    inset: 4px;
    border-radius: 50%;
    background: repeating-radial-gradient(
      circle at center,
      transparent 0px,
      transparent 1.5px,
      rgba(255,255,255,0.03) 1.5px,
      rgba(255,255,255,0.03) 2px
    );
  }

  .vinyl-shine {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: linear-gradient(
      135deg,
      transparent 0%,
      rgba(255,255,255,0.1) 45%,
      transparent 50%,
      transparent 100%
    );
    pointer-events: none;
  }

  .vinyl-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--color-brand);
    background-size: cover;
    background-position: center;
    box-shadow: 0 0 8px rgba(249, 115, 22, 0.3);
  }

  .label-ring {
    position: absolute;
    inset: 2px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.2);
  }

  .vinyl-spindle {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 4px;
    height: 4px;
    background: #444;
    border-radius: 50%;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
  }

  /* Tonearm */
  .tonearm {
    position: absolute;
    right: 12px;
    top: 12px;
    width: 40px;
    height: 50px;
  }

  .tonearm-base {
    position: absolute;
    right: 0;
    top: 0;
    width: 12px;
    height: 12px;
    background: linear-gradient(145deg, #444, #222);
    border-radius: 50%;
    border: 1px solid #555;
  }

  .tonearm-arm {
    position: absolute;
    right: 4px;
    top: 6px;
    width: 32px;
    height: 4px;
    background: linear-gradient(180deg, #888, #555);
    border-radius: 2px;
    transform-origin: right center;
    transform: rotate(35deg);
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .tonearm.playing .tonearm-arm {
    transform: rotate(15deg);
  }

  .tonearm-head {
    position: absolute;
    left: -6px;
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 8px;
    background: #333;
    border-radius: 2px;
  }

  .tonearm-cartridge {
    position: absolute;
    bottom: -3px;
    left: 50%;
    transform: translateX(-50%);
    width: 2px;
    height: 5px;
    background: var(--color-brand);
  }

  /* Deck Controls */
  .deck-controls {
    position: absolute;
    right: 8px;
    bottom: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: center;
  }

  .power-btn {
    width: 14px;
    height: 14px;
    background: linear-gradient(145deg, #333, #1a1a1a);
    border: 1px solid #444;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .power-led {
    width: 6px;
    height: 6px;
    background: #333;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .power-btn.on .power-led {
    background: var(--color-success);
    box-shadow: 0 0 6px var(--color-success);
  }

  .speed-selector {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .speed-dot {
    width: 4px;
    height: 4px;
    background: #444;
    border-radius: 50%;
  }

  .speed-dot.active {
    background: var(--color-brand);
    box-shadow: 0 0 4px var(--color-brand);
  }

  .speed-label {
    font-family: var(--font-family-mono);
    font-size: 8px;
    color: var(--color-text-dimmed);
  }

  /* Status indicator */
  .status-led {
    width: 6px;
    height: 6px;
    background: var(--color-border-strong);
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .status-led.active {
    background: var(--color-success);
    box-shadow: 0 0 6px var(--color-success);
    animation: pulse-glow 2s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 4px var(--color-success); }
    50% { box-shadow: 0 0 8px var(--color-success); }
  }

  /* EQ Bars */
  .eq-container {
    display: flex;
    align-items: flex-end;
    gap: 3px;
    height: 16px;
  }

  .eq-bar {
    width: 4px;
    height: 4px;
    background: var(--color-border-strong);
    border-radius: 1px;
    transition: height 0.15s ease, background 0.3s ease;
  }

  .eq-container.playing .eq-bar {
    background: var(--color-brand);
    animation: eq-bounce 0.5s ease-in-out infinite;
  }

  .eq-container.playing .eq-bar:nth-child(1) { animation-delay: 0s; }
  .eq-container.playing .eq-bar:nth-child(2) { animation-delay: 0.1s; }
  .eq-container.playing .eq-bar:nth-child(3) { animation-delay: 0.2s; }
  .eq-container.playing .eq-bar:nth-child(4) { animation-delay: 0.05s; }
  .eq-container.playing .eq-bar:nth-child(5) { animation-delay: 0.15s; }
  .eq-container.playing .eq-bar:nth-child(6) { animation-delay: 0.25s; }
  .eq-container.playing .eq-bar:nth-child(7) { animation-delay: 0.08s; }
  .eq-container.playing .eq-bar:nth-child(8) { animation-delay: 0.18s; }

  @keyframes eq-bounce {
    0%, 100% { height: 4px; }
    50% { height: 16px; }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .vinyl.spinning { animation: none; }
    .eq-container.playing .eq-bar { animation: none; height: 10px; }
    .status-led.active { animation: none; }
  }
</style>

<script>
  const container = document.querySelector('[data-now-playing]');
  if (container) {
    const titleEl = container.querySelector('#np-title') as HTMLElement;
    const artistEl = container.querySelector('#np-artist') as HTMLElement;
    const albumEl = container.querySelector('#np-album') as HTMLElement;
    const linkEl = container.querySelector('#np-link') as HTMLAnchorElement;
    const vinylEl = container.querySelector('#vinyl') as HTMLElement;
    const labelEl = container.querySelector('#vinyl-label') as HTMLElement;
    const tonearmEl = container.querySelector('#tonearm') as HTMLElement;
    const powerBtnEl = container.querySelector('#power-btn') as HTMLElement;
    const statusLedEl = container.querySelector('.status-led') as HTMLElement;
    const statusTextEl = container.querySelector('.status-text') as HTMLElement;
    const eqBarsEl = container.querySelector('#eq-bars') as HTMLElement;

    interface TrackData {
      title: string;
      artist: string;
      album: string;
      url: string;
      art: string;
      nowPlaying: boolean;
    }

    function normalize(data: any): TrackData {
      const track = data?.track || {};
      const images = Array.isArray(track.image) ? track.image : [];
      const sizes = ['extralarge', 'large', 'medium', 'small'];
      let art = '';
      
      for (const size of sizes) {
        const img = images.find((i: any) => i?.size === size && i?.['#text']);
        if (img?.['#text']) {
          art = img['#text'];
          break;
        }
      }
      
      if (!art && images.length) {
        art = images[images.length - 1]?.['#text'] || '';
      }

      return {
        title: track.name || '',
        artist: track.artist?.['#text'] || '',
        album: track.album?.['#text'] || '',
        url: track.url || '',
        art,
        nowPlaying: String(track['@attr']?.nowplaying) === 'true',
      };
    }

    function apply(data: TrackData) {
      const isPlaying = data.nowPlaying && (data.title || data.artist);

      titleEl.textContent = data.title || 'Nothing playing';
      artistEl.textContent = data.artist || 'â€”';
      albumEl.textContent = data.album ? `ðŸ’¿ ${data.album}` : 'â€”';
      
      if (data.url) {
        linkEl.href = data.url;
        linkEl.style.pointerEvents = 'auto';
      } else {
        linkEl.href = '#';
        linkEl.style.pointerEvents = 'none';
      }

      // Update vinyl label with album art
      if (data.art) {
        labelEl.style.backgroundImage = `url("${data.art}")`;
      } else {
        labelEl.style.backgroundImage = '';
      }

      // Toggle animations
      vinylEl.classList.toggle('spinning', isPlaying);
      tonearmEl.classList.toggle('playing', isPlaying);
      powerBtnEl.classList.toggle('on', isPlaying);
      statusLedEl.classList.toggle('active', isPlaying);
      eqBarsEl.classList.toggle('playing', isPlaying);
      statusTextEl.textContent = isPlaying ? 'Live' : 'Idle';
    }

    async function fetchTrack() {
      try {
        const response = await fetch(
          'https://lastfm-last-played.biancarosa.com.br/bmcweeney/latest-song',
          { cache: 'no-store' }
        );
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();
        apply(normalize(data));
      } catch {
        apply({
          title: '',
          artist: '',
          album: '',
          url: '',
          art: '',
          nowPlaying: false,
        });
      }
    }

    fetchTrack();
    setInterval(fetchTrack, 30000);
  }
</script>